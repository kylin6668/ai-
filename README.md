一个基于 **向量检索** + **大语言模型（LLM）** 的智能问答系统，支持通过自然语言查询特定时间、地区的白菜价格，提供RESTful API接口，可快速集成到前端应用。



<h2 id="qfn9v">功能特性</h2>
+ **多维度精准查询**：支持按省份、城市、日期、品种（大白菜及相关品类）筛选价格数据
+ **上下文对话**：理解多轮交互中的指代关系（如“那上海昨天的价格呢？”）
+ **向量库热更新**：数据源变更后，可通过API一键重建向量库，无需重启服务
+ **完整数据溯源**：返回查询结果时附带原始数据源，确保信息可追溯
+ **健壮的错误处理**：空值填充、API连接检测、无效查询提示等，保障系统稳定性



<h2 id="UYLiH">技术栈</h2>
| 类别 | 技术选型 | 作用说明 |
| --- | --- | --- |
| 核心框架 | LangChain 0.3.x | 构建检索链、对话历史管理、LLM调用流程 |
| 向量数据库 | Chroma 1.0.20 | 存储文本向量，实现高效相似性检索 |
| 大语言模型 | 智谱AI glm-z1-flash | 生成自然语言回答，理解上下文对话 |
| 嵌入模型 | 智谱AI embedding-2 | 将文本转换为向量，用于检索匹配 |
| API框架 | FastAPI 0.116.1 | 提供RESTful接口，支持自动生成接口文档 |
| ASGI服务器 | Uvicorn 0.35.0 | 运行FastAPI应用，支持高并发请求 |
| 数据处理 | Pandas 2.3.2 + 正则表达式 | 清洗CSV数据、提取结构化元数据（省/市/日期） |
| 环境管理 | python-dotenv 1.1.1 | 加载API密钥等敏感配置，避免硬编码 |


<h2 id="VpcMF">项目结构</h2>
```plain
├── cabbage_prices.csv       # 白菜价格数据源（需自行准备，格式见下文）
├── data_processor.py        # 数据清洗：空值填充、元数据提取、文本模板化
├── vector_db.py             # 向量库管理：分批写入向量、持久化存储
├── qa_chain.py              # 问答核心：历史感知检索器、回答生成链
├── api_server.py            # API服务：/chat查询、/health检查、/rebuild重建向量库
├── requirements.txt         # 项目依赖清单（含版本号，一键安装）
├── .env                     # 环境配置（存放智谱API密钥，需自行创建）
└── README.md                # 项目说明文档（本文档）
```



<h2 id="d8Icc">快速开始</h2>
<h3 id="oSSAL">1. 环境准备</h3>
<h4 id="qaOiq">1.1 安装依赖</h4>
首先确保本地已安装 **Python 3.8+**，然后执行以下命令安装所有依赖：

```bash
pip install -r requirements.txt
```

<h4 id="nSjbh">1.2 配置环境变量</h4>
创建 `.env` 文件，填入智谱AI API密钥（需从[智谱AI开放平台](https://open.bigmodel.cn/)申请）：

```plain
# .env 文件内容
ZHIPUAI_API_KEY=your_zhipu_api_key_here  # 替换为你的实际API密钥
```

<h4 id="WGuxQ">1.3 准备数据源</h4>
确保 `cabbage_prices.csv` 文件包含以下字段（字段名需完全一致）：

| 字段名 | 示例值 | 说明 |
| --- | --- | --- |
| 品种 | 大白菜 | 支持“圆白菜”“洋白菜”等别名映射 |
| 批发市场 | 山东青岛城阳蔬菜批发市场 | 用于提取省份、城市信息 |
| 最低价 | 1.2 | 单位：元 |
| 最高价 | 1.8 | 单位：元 |
| 平均价 | 1.5 | 单位：元 |
| 发布日期 | 2024-05-20 | 格式：YYYY-MM-DD |


<h3 id="WbgZc">2. 启动服务</h3>
<h4 id="cRsxs">2.1 初始化向量库（首次启动必做）</h4>
首次运行需将CSV数据转换为向量并存入Chroma，执行：

```bash
python vector_db.py
```

+ 提示 `全部数据处理完成，共导入 X 条白菜价格数据` 表示初始化成功
+ 向量库会持久化到 `./chroma_db_zhipu` 目录，后续启动无需重复执行

<h4 id="jhVdx">2.2 启动API服务</h4>
```bash
python api_server.py
```

服务启动后，默认运行在 `http://0.0.0.0:8000`，支持局域网访问：

+ 接口文档：访问 `http://localhost:8000/docs` 可查看所有API并在线调试
+ 健康检查：访问 `http://localhost:8000/health` 查看服务状态



<h2 id="wuVIk">API接口说明</h2>
<h3 id="tr09S">1. 健康检查（GET /health）</h3>
**功能**：查看服务状态、向量库数据量、使用的LLM模型  
**响应示例**：

```json
{
  "status": "ok",
  "vectors": 120,  # 向量库中数据条数
  "model": "glm-z1-flash"
}
```

<h3 id="DpVFQ">2. 价格查询（POST /chat）</h3>
**功能**：接收自然语言问题，返回白菜价格回答及数据源  
**请求体示例**：

```json
{
  "question": "2024年5月20日山东青岛的大白菜平均价是多少？"
}
```

**响应示例**：

```json
{
  "answer": "品种：大白菜，批发市场：山东青岛城阳蔬菜批发市场，最低价：1.2元，最高价：1.8元，平均价：1.5元，发布日期：2024-05-20",
  "retrieved_count": 1,  # 检索到的相关数据条数
  "sources": [
    "品种：大白菜，批发市场：山东青岛城阳蔬菜批发市场，最低价：1.2元，最高价：1.8元，平均价：1.5元，发布日期：2024-05-20"
  ]  # 原始数据源
}
```

<h3 id="nmEiD">3. 重建向量库（POST /rebuild）</h3>
**功能**：当 `cabbage_prices.csv` 数据更新后，删除旧向量库并重新构建  
**注意**：操作耗时取决于数据量，期间无法正常查询  
**响应示例**：

```json
{
  "status": "ok",
  "message": "向量库已重建并重新加载"
}
```



<h2 id="HQbP7">数据处理流程</h2>
1. **数据清洗**：`data_processor.py` 加载CSV，用“无数据”填充空值，避免后续报错
2. **元数据提取**：通过正则从“批发市场”字段提取省份（前2字）、城市（如“青岛”），从“发布日期”提取年、月-日
3. **文本模板化**：将每条数据转换为统一格式（如“品种：XXX，批发市场：XXX...”），确保向量生成时保留关键信息
4. **向量生成与存储**：`vector_db.py` 用智谱embedding-2模型将文本转为向量，每批60条写入Chroma（规避API限制）
5. **问答流程**：
    - `qa_chain.py` 解析用户问题，提取筛选条件（如日期、地区）
    - 基于元数据过滤向量库，检索最相关的6条数据
    - 结合对话历史，让LLM基于检索到的数据生成回答



<h2 id="h72OM">使用示例</h2>
<h3 id="Eg8T8">示例1：基础查询</h3>
**问题**：“北京2024年5月的大白菜价格是多少？”  
**回答**：“品种：大白菜，批发市场：北京新发地农产品批发市场，最低价：1.5元，最高价：2.2元，平均价：1.8元，发布日期：2024-05-15”

<h3 id="yA5D3">示例2：多轮对话</h3>
**用户1**：“上海的大白菜最低价是多少？”  
**回答1**：“品种：大白菜，批发市场：上海江桥批发市场，最低价：1.3元，最高价：1.9元，平均价：1.6元，发布日期：2024-05-18”  
**用户2**：“那最高价呢？”  
**回答2**：“品种：大白菜，批发市场：上海江桥批发市场，最低价：1.3元，最高价：1.9元，平均价：1.6元，发布日期：2024-05-18”（自动关联上一轮的“上海”和“大白菜”）



<h2 id="Y77KT">注意事项</h2>
1. **API密钥有效性**：智谱API密钥需保持有效，若过期需重新申请并更新 `.env` 文件
2. **网络环境**：确保服务器能访问智谱AI接口（`https://open.bigmodel.cn/api/paas/v4/`），如需代理需额外配置
3. **数据格式**：`cabbage_prices.csv` 字段名不可修改，日期格式需为 `YYYY-MM-DD`，否则元数据提取会失败
4. **并发限制**：默认Uvicorn配置支持中等并发，高并发场景需调整 `workers` 参数（如 `uvicorn api_server:app --workers 4`）



<h2 id="FPQZa">常见问题</h2>
Q1：启动 `vector_db.py` 时报“智谱API连接测试失败”？  
A1：检查网络是否通畅，或是否需要配置代理；确认 `.env` 中的API密钥是否正确。

Q2：查询时返回“未找到相关价格数据”？  
A2：可能原因：1. 向量库中无匹配条件的数据；2. 问题中的地区/日期表述不明确（如“昨天”需结合当前日期，但数据中无对应记录）。

Q3：重建向量库后查询结果未更新？  
A3：重建后需等待接口返回“向量库已重建并重新加载”，再进行查询；若仍有问题，可重启API服务。

